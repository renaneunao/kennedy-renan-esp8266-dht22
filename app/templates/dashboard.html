{% extends "base.html" %}

{% block title %}Dashboard - ESP8266 DHT22 Monitor{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2>
            <i class="fas fa-chart-line me-2"></i>
            Dashboard em Tempo Real
        </h2>
        <p class="text-muted">Monitoramento contínuo de temperatura e umidade</p>
    </div>
</div>

<!-- Controles -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Controles</h5>
                <div class="row">
                    <div class="col-md-6">
                        <label for="timeRange" class="form-label">Período:</label>
                        <select class="form-select" id="timeRange" onchange="updateCharts()">
                            <option value="1">Última hora</option>
                            <option value="6">Últimas 6 horas</option>
                            <option value="24" selected>Últimas 24 horas</option>
                            <option value="168">Última semana</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="deviceSelect" class="form-label">Dispositivo:</label>
                        <select class="form-select" id="deviceSelect" onchange="updateCharts()">
                            <option value="">Todos os dispositivos</option>
                        </select>
                    </div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-primary" onclick="updateCharts()">
                        <i class="fas fa-sync-alt me-1"></i>
                        Atualizar
                    </button>
                    <button class="btn btn-success" onclick="toggleAutoRefresh()">
                        <i class="fas fa-play me-1" id="refresh-icon"></i>
                        <span id="refresh-text">Auto Refresh</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Status Atual</h5>
                <div class="row">
                    <div class="col-6">
                        <div class="text-center">
                            <i class="fas fa-thermometer-half fa-2x text-danger mb-2"></i>
                            <h4 id="current-temp-dash">--°C</h4>
                            <small class="text-muted">Temperatura</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center">
                            <i class="fas fa-tint fa-2x text-info mb-2"></i>
                            <h4 id="current-humidity-dash">--%</h4>
                            <small class="text-muted">Umidade</small>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="text-center">
                    <small class="text-muted">
                        Última atualização: <span id="last-update-dash">--</span>
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Gráficos -->
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-area me-2"></i>
                    Gráfico de Temperatura e Umidade
                </h5>
            </div>
            <div class="card-body">
                <canvas id="mainChart" height="100"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    Distribuição da Umidade
                </h5>
            </div>
            <div class="card-body">
                <canvas id="humidityChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Tabela de Dados Recentes -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-table me-2"></i>
                    Dados Recentes
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="dataTable">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Dispositivo</th>
                                <th>Temperatura</th>
                                <th>Umidade</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody">
                            <tr>
                                <td colspan="5" class="text-center">Carregando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let mainChart, humidityChart;
let autoRefreshInterval;
let isAutoRefresh = false;

// Inicializar dashboard
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    loadDevices();
    updateCharts();
    updateCurrentData();
    
    // Atualizar dados a cada 30 segundos
    setInterval(updateCurrentData, 30000);
});

function initializeCharts() {
    // Gráfico principal
    const ctx = document.getElementById('mainChart').getContext('2d');
    mainChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Temperatura (°C)',
                data: [],
                borderColor: 'rgb(220, 53, 69)',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.4,
                yAxisID: 'y'
            }, {
                label: 'Umidade (%)',
                data: [],
                borderColor: 'rgb(13, 202, 240)',
                backgroundColor: 'rgba(13, 202, 240, 0.1)',
                tension: 0.4,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Tempo'
                    }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Temperatura (°C)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Umidade (%)'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                }
            }
        }
    });

    // Gráfico de umidade
    const humidityCtx = document.getElementById('humidityChart').getContext('2d');
    humidityChart = new Chart(humidityCtx, {
        type: 'doughnut',
        data: {
            labels: ['Baixa (0-30%)', 'Normal (30-70%)', 'Alta (70-100%)'],
            datasets: [{
                data: [0, 0, 0],
                backgroundColor: [
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 205, 86, 0.8)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

function loadDevices() {
    fetch('/api/sensor-data/latest')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const devices = [...new Set(data.data.map(item => item.device_id))];
                const select = document.getElementById('deviceSelect');
                select.innerHTML = '<option value="">Todos os dispositivos</option>';
                devices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device;
                    option.textContent = device;
                    select.appendChild(option);
                });
            }
        });
}

function updateCharts() {
    const timeRange = document.getElementById('timeRange').value;
    const deviceId = document.getElementById('deviceSelect').value;
    
    let url = `/api/sensor-data?limit=${timeRange * 60}`;
    if (deviceId) {
        url += `&device_id=${deviceId}`;
    }
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                updateMainChart(data.data);
                updateHumidityChart(data.data);
                updateDataTable(data.data);
            }
        })
        .catch(error => {
            console.error('Erro ao atualizar gráficos:', error);
        });
}

function updateMainChart(data) {
    const labels = data.map(item => new Date(item.timestamp).toLocaleTimeString('pt-BR'));
    const temperatures = data.map(item => item.temperature);
    const humidities = data.map(item => item.humidity);
    
    mainChart.data.labels = labels;
    mainChart.data.datasets[0].data = temperatures;
    mainChart.data.datasets[1].data = humidities;
    mainChart.update();
}

function updateHumidityChart(data) {
    const humidities = data.map(item => item.humidity);
    const low = humidities.filter(h => h < 30).length;
    const normal = humidities.filter(h => h >= 30 && h <= 70).length;
    const high = humidities.filter(h => h > 70).length;
    
    humidityChart.data.datasets[0].data = [low, normal, high];
    humidityChart.update();
}

function updateDataTable(data) {
    const tbody = document.getElementById('dataTableBody');
    tbody.innerHTML = '';
    
    data.slice(0, 10).forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${new Date(item.timestamp).toLocaleString('pt-BR')}</td>
            <td>${item.device_id}</td>
            <td>${item.temperature.toFixed(1)}°C</td>
            <td>${item.humidity.toFixed(1)}%</td>
            <td><span class="badge bg-success">OK</span></td>
        `;
        tbody.appendChild(row);
    });
}

function updateCurrentData() {
    fetch('/api/sensor-data/latest')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success' && data.data.length > 0) {
                const latest = data.data[0];
                document.getElementById('current-temp-dash').textContent = latest.temperature.toFixed(1) + '°C';
                document.getElementById('current-humidity-dash').textContent = latest.humidity.toFixed(1) + '%';
                document.getElementById('last-update-dash').textContent = new Date(latest.timestamp).toLocaleString('pt-BR');
            }
        });
}

function toggleAutoRefresh() {
    const icon = document.getElementById('refresh-icon');
    const text = document.getElementById('refresh-text');
    
    if (isAutoRefresh) {
        clearInterval(autoRefreshInterval);
        icon.className = 'fas fa-play me-1';
        text.textContent = 'Auto Refresh';
        isAutoRefresh = false;
    } else {
        autoRefreshInterval = setInterval(updateCharts, 30000);
        icon.className = 'fas fa-pause me-1';
        text.textContent = 'Pausar';
        isAutoRefresh = true;
    }
}
</script>
{% endblock %}

