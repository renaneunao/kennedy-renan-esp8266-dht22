name: Docker Build and Push - ESP8266 DHT22 Monitor

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: renaneunao
        password: ${{ secrets.DOCKERHUB_ACCESS_TOKEN }}
    
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: renaneunao/esp8266-dht22
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
          type=raw,value=stable,enable={{is_default_branch}}
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: ./app
        file: ./app/Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64,linux/arm64
    
    - name: Update Docker Hub description
      if: github.ref == 'refs/heads/main'
      run: |
        curl -X PATCH \
          -H "Authorization: JWT ${{ secrets.DOCKERHUB_ACCESS_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d '{
            "full_description": "# ESP8266 DHT22 Monitor - Sistema IoT\n\nSistema completo de monitoramento de temperatura e umidade usando ESP8266 com sensor DHT22, conectado a uma aplicaÃ§Ã£o web Flask que armazena e visualiza os dados em tempo real.\n\n## ğŸ—ï¸ Arquitetura\n\n```\nESP8266 + DHT22 â†’ WiFi â†’ Flask API â†’ SQLite â†’ Interface Web\n```\n\n## âœ¨ CaracterÃ­sticas\n\n- ğŸŒ¡ï¸ **Monitoramento em Tempo Real**: Temperatura e umidade\n- ğŸ“Š **Dashboard Interativo**: GrÃ¡ficos e estatÃ­sticas\n- ğŸ”„ **SincronizaÃ§Ã£o AutomÃ¡tica**: Dados enviados a cada minuto\n- ğŸ“± **Interface Responsiva**: Funciona em mobile e desktop\n- ğŸ³ **Docker Ready**: Pronto para deploy em containers\n- ğŸ” **API Segura**: AutenticaÃ§Ã£o com API keys\n- ğŸ“ˆ **Analytics**: EstatÃ­sticas e tendÃªncias\n\n## ğŸš€ Tecnologias\n\n- **Backend**: Flask, SQLAlchemy, SQLite\n- **Frontend**: HTML5, Bootstrap, Chart.js\n- **IoT**: ESP8266, DHT22, Arduino\n- **Deploy**: Docker, Nginx, Gunicorn\n- **CI/CD**: GitHub Actions\n\n## ğŸ“¦ Como usar\n\n```bash\n# Executar com Docker Compose\ndocker-compose up -d\n\n# Acessar a aplicaÃ§Ã£o\nhttp://localhost:5005\n\n# API endpoints\ncurl http://localhost:5005/api/sensor-data/latest\n```\n\n## ğŸ”§ ConfiguraÃ§Ã£o ESP8266\n\n1. Configure WiFi no arquivo `config.h`\n2. Configure URL do servidor\n3. FaÃ§a upload do cÃ³digo para ESP8266\n4. Conecte sensor DHT22 no pino D4\n\n## ğŸ“Š Endpoints da API\n\n- `GET /api/sensor-data` - Dados histÃ³ricos\n- `GET /api/sensor-data/latest` - Ãšltimos dados\n- `GET /api/sensor-data/stats` - EstatÃ­sticas\n- `POST /api/sensor-data` - Enviar dados (ESP8266)\n- `GET /api/health` - Health check\n\n## ğŸ” SeguranÃ§a\n\n- API Key obrigatÃ³ria para envio de dados\n- Rate limiting configurado\n- Headers de seguranÃ§a\n- HTTPS com SSL/TLS\n\n## ğŸ“ˆ Monitoramento\n\n- Health checks automÃ¡ticos\n- Logs estruturados\n- MÃ©tricas de performance\n- Alertas de sistema\n\n## ğŸ› ï¸ Desenvolvimento\n\n```bash\n# Instalar dependÃªncias\npip install -r app/requirements.txt\n\n# Executar em desenvolvimento\ncd app && python app.py\n\n# Testar API\ncurl -X POST http://localhost:5005/api/sensor-data \\\n  -H \"Content-Type: application/json\" \\\n  -H \"X-API-Key: sua_api_key\" \\\n  -d \"{\\\"temperature\\\":25.6,\\\"humidity\\\":60.2,\\\"device_id\\\":\\\"ESP8266_001\\\"}\"\n```\n\n## ğŸ“ Suporte\n\n- **DocumentaÃ§Ã£o**: [GitHub Wiki](https://github.com/renaneunao/esp8266-dht22/wiki)\n- **Issues**: [GitHub Issues](https://github.com/renaneunao/esp8266-dht22/issues)\n- **Email**: renan@exemplo.com\n\n---\n\n**âš ï¸ Importante**: Configure adequadamente as variÃ¡veis de ambiente e API keys antes do uso em produÃ§Ã£o!"
          }' \
          "https://hub.docker.com/v2/repositories/renaneunao/esp8266-dht22/"
    
    - name: Verify deployment
      run: |
        echo "âœ… Docker image built and pushed successfully to Docker Hub!"
        echo "ğŸ“¦ Image tags: ${{ steps.meta.outputs.tags }}"
        echo "ğŸŒ Docker Hub: https://hub.docker.com/r/renaneunao/esp8266-dht22"
        echo "ğŸš€ Ready for deployment!"
    
    - name: Security scan
      if: github.event_name == 'push'
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: renaneunao/esp8266-dht22-monitor:latest
        format: 'sarif'
        output: 'trivy-results.sarif'
    
    - name: Upload Trivy scan results
      if: github.event_name == 'push'
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'
